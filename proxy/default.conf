server {
	listen       80;

  resolver 127.0.0.11; # docker dns resolver


# Preflighted requests
    if ($request_method = OPTIONS ) {
      add_header "Access-Control-Allow-Origin"  *;
      add_header "Access-Control-Allow-Methods" "GET, POST, OPTIONS, HEAD";
      add_header "Access-Control-Allow-Headers" "Authorization, Origin, X-Requested-With, Content-Type, Accept";
      return 200;
    }

  # Add header when proxing to service
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  
  # Add header when responding to query (from service)
  add_header 'Access-Control-Allow-Origin' '*';

	location / {
		return      401;
	}

  # Static files
	location /assets {
    # files in /www/assets/
		root /www/;
	}

  # Service Hello
	location /hello/ {
    set $addr http://front:80;

    # replace all occurences of "proxy" by the proxy hostname
    sub_filter_types application/javascript;
    sub_filter 'http://proxy/' '{{PROXY_URL}}/';

    rewrite ^/hello(.*)$ $1 break;
    proxy_pass $addr$uri;
	}
	
	# Service alumnis
	location /alumnis/ {
    set $addr http://service_alumni:3000;
    
    rewrite ^/alumnis(.*)$ $1 break;
    proxy_pass $addr$uri;
	}

	# Service user
  location /users/ {
    set $addr http://service_user:3000;

    rewrite ^/users(.*)$ $1 break;
    proxy_pass $addr$uri;
  }

}
